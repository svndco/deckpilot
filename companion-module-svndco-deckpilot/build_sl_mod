#!/bin/bash

# build_sl_mod - Build and install AE.Live: DeckPilot Companion Module
# This script builds and installs the module to Companion's Application Support directory

set -e

# Change to the script's directory
SCRIPT_DIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )"
cd "$SCRIPT_DIR"

echo "Working directory: $SCRIPT_DIR"
echo ""
echo "Building Companion module..."
npm run build
npm run companion-mod-build

echo ""
echo "Installing module to Companion..."
MODULE_NAME="svndco-deckpilot-0.0.2"
COMPANION_DIR="$HOME/Library/Application Support/companion/modules"
TARGET_DIR="$COMPANION_DIR/$MODULE_NAME"

# Remove old version
if [ -d "$TARGET_DIR" ]; then
    echo "Removing old module version..."
    rm -rf "$TARGET_DIR"
fi

# Create target directory
mkdir -p "$TARGET_DIR"

# Extract tarball
echo "Extracting module package..."
tar -xzf "$MODULE_NAME.tgz" -C "$TARGET_DIR" --strip-components=1

echo ""
echo "âœ“ Module installed successfully to:"
echo "  $TARGET_DIR"
echo ""
echo "Module contents:"
ls -lh "$TARGET_DIR"
echo ""
echo "IMPORTANT: Restart Companion completely to load the module."
echo "The module will appear as 'SVND.co: DeckPilot' in the connections list."
